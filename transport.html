<!DOCTYPE html>
<html lang="ro">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Registru Transport</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary-gradient: linear-gradient(135deg, #0061f2 0%, #69a6ce 100%); --bg-light: #f8f9fa; --text-dark: #2d3748; --accent-color: #0061f2; }
    body { background-color: var(--bg-light); font-family: 'Poppins', sans-serif; color: var(--text-dark); padding-top: 160px; padding-bottom: 80px; margin: 0; }

    /* Header */
    .fixed-header-wrapper { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background-color: var(--bg-light); box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    .app-header { background: var(--primary-gradient); color: white; padding: 15px 20px 50px; border-radius: 0 0 30px 30px; display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .user-pill { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); }
    .top-nav { display: flex; justify-content: center; gap: 10px; margin-top: -25px; margin-bottom: 10px; padding: 0 15px; }
    .nav-pill-btn { border: none; padding: 12px 0; border-radius: 50px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: 0.3s; flex: 1; text-align: center; max-width: 200px; cursor: pointer; }
    .nav-pill-btn.active { background: #2d3748; color: white; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    .nav-pill-btn:not(.active) { background: white; color: #4a5568; }

    .responsive-container { width: 100%; padding: 0 15px; margin: 0 auto; }
    @media (min-width: 768px) { .responsive-container { max-width: 95%; } }

    /* List Items */
    .accordion-item { border: none; background: transparent; margin-bottom: 15px; }
    .accordion-button { border-radius: 15px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.03); color: #4a5568; font-weight: 700; padding: 15px; background: white; font-size: 1rem; }
    .accordion-button:not(.collapsed) { background: #eef5ff; color: var(--accent-color); }
    .accordion-button::after { display: none; }
    .month-chevron { transition: transform 0.3s; margin-left: auto; }
    .accordion-button:not(.collapsed) .month-chevron { transform: rotate(180deg); }

    /* Sub-Accordion Santier */
    .sub-accordion-btn {
        background: white !important; border: 1px solid #eef2f7; margin-top: 6px; border-radius: 12px !important;
        padding: 10px 15px; font-weight: 600; font-size: 0.85rem; color: #4a5568; width: 100%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.02); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    }
    .site-name-container { justify-self: start; text-align: left; }
    .site-badge-container { justify-self: center; }
    .site-arrow-container { justify-self: end; }
    .site-badge { background: var(--primary-gradient); color: white; font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; font-weight: 700; }
    .fa-chevron-down.site-chev { transition: transform 0.3s; font-size: 0.8rem; color: #a0aec0; }
    .sub-accordion-btn[aria-expanded="true"] .site-chev { transform: rotate(180deg); color: var(--accent-color); }

    /* Trip Card */
    .trip-card { background: white; border-radius: 16px; padding: 12px 18px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border-left: 4px solid var(--accent-color); position: relative; cursor: pointer; transition: 0.2s; }
    .trip-date { font-size: 0.75rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
    .trip-main { font-weight: 700; font-size: 0.95rem; color: #1a202c; margin-bottom: 2px; }
    .trip-sub { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 5px; }
    .trip-amount { font-size: 0.95rem; font-weight: 700; color: #16a34a; position: absolute; top: 15px; right: 15px; }

    /* Refresh Button */
    .refresh-container { display: flex; justify-content: flex-end; margin-bottom: 15px; padding-right: 5px; margin-top: 15px; }
    .btn-refresh-custom { background-color: #edf2f7; color: #4a5568; border: none; font-weight: 600; font-size: 0.8rem; padding: 8px 18px; border-radius: 20px; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
    .btn-refresh-custom:hover { background-color: #cbd5e0; color: #2d3748; }

    /* Modal Detalii */
    .detail-section { margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
    .detail-section-title { font-size: 0.75rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; margin-bottom: 10px; }
    .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
    .detail-label { color: #718096; font-weight: 500; text-transform: uppercase; font-size: 0.8rem; }
    .detail-val { font-weight: 600; color: #2d3748; text-align: right; max-width: 65%; }
    .btn-view-photo { background: #eef5ff; color: var(--accent-color); border: none; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
    .btn-view-photo:hover { background: #dbeafe; }

    /* Formular */
    .form-container-width { max-width: 600px; margin: 0 auto; }
    .form-control { border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; }
    .form-section-title { color: var(--accent-color); font-weight: 700; margin: 20px 0 10px; font-size: 0.9rem; text-transform: uppercase; }
    
    .photo-box { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 15px; text-align: center; color: #a0aec0; background: #fff; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .photo-box.has-file { border-color: #16a34a; color: #16a34a; background: #f0fdf4; font-weight: 600; }
    /* Buton "VEZI" peste poza */
    .btn-preview-overlay {
        position: absolute; top: 5px; right: 5px;
        background: #28a745; color: white;
        font-size: 0.7rem; font-weight: 700;
        padding: 3px 8px; border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10; display: none;
        cursor: pointer;
    }
    .photo-box.has-file .btn-preview-overlay { display: block; }

    .autocomplete-wrapper { position: relative; }
    .autocomplete-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
    .autocomplete-item { padding: 12px; border-bottom: 1px solid #f7f7f7; cursor: pointer; }
    
    .hidden { display: none !important; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .btn-back { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 10px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold text-muted" id="loaderText">Se iniÈ›ializeazÄƒ...</div>
  </div>

  <div id="main-app" class="hidden">
    <div class="fixed-header-wrapper">
        <div class="app-header">
          <div class="d-flex align-items-center">
              <button class="btn-back" onclick="window.location.href='index.html'"><i class="fa-solid fa-arrow-left"></i></button>
              <div class="header-title ms-2"><i class="fas fa-truck-moving"></i> Transport</div>
          </div>
          <div class="d-flex align-items-center gap-2">
              <div id="netStatus" class="badge bg-success rounded-pill d-flex align-items-center gap-1 shadow-sm" style="font-size:0.75rem;">
                  <i class="fas fa-wifi"></i> <span>ONLINE</span>
              </div>
              <div class="user-pill"><i class="fas fa-user-circle"></i> <span id="userDisplay">User</span></div>
          </div>
        </div>
        <div class="top-nav">
           <button class="nav-pill-btn active" id="tab-list" onclick="switchView('list')">Istoric Curse</button>
           <button class="nav-pill-btn" id="tab-add" onclick="openAddScreen()">AdaugÄƒ CursÄƒ</button>
        </div>
        <div id="syncMessage" class="bg-warning text-dark text-center py-1 small fw-bold hidden"></div>
    </div>

    <div class="responsive-container">
      
      <div id="view-list">
        <div class="refresh-container">
             <button type="button" class="btn-refresh-custom shadow-sm" onclick="loadHistory()">
                <i class="fa-solid fa-rotate"></i> ActualizeazÄƒ
             </button>
        </div>
        <div id="trips-container" class="pb-5"></div>
      </div>

      <div id="view-add" class="hidden pb-5">
         <div class="form-container-width">
             <form id="transportForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <input type="file" id="universalCameraInput" accept="image/*" style="display:none" onchange="processScanResult()">

                <div class="card p-3 border-0 shadow-sm mb-3">
                    <div class="form-section-title d-flex justify-content-between align-items-center mt-0">
                        <span><i class="fas fa-file-invoice me-2"></i>Documente</span>
                    </div>

                    <div class="p-2 mb-3 border rounded bg-light">
                        <h6 class="fw-bold text-primary small m-0 mb-2">AVIZ 1 (ÃŽncarcÄƒ pentru extragere)</h6>
                        <div class="d-flex gap-2">
                            <div class="photo-box flex-fill bg-white" id="box_fileAviz1" onclick="triggerInput('fileAviz1', event)">
                                <div class="btn-preview-overlay" onclick="previewImage('fileAviz1', event)">VEZI</div>
                                <i class="fas fa-camera fa-lg mb-1"></i><br>PozÄƒ Aviz
                                <input type="file" id="fileAviz1" hidden onchange="handleImageUpload(this, 'aviz1')">
                            </div>
                            <div class="photo-box flex-fill bg-white" id="box_fileTichet1" onclick="triggerInput('fileTichet1', event)">
                                <div class="btn-preview-overlay" onclick="previewImage('fileTichet1', event)">VEZI</div>
                                <i class="fas fa-ticket-alt fa-lg mb-1"></i><br>Tichet
                                <input type="file" id="fileTichet1" hidden onchange="previewOnly(this)">
                            </div>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkAviz2" onchange="toggleDiv('secAviz2', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">Al doilea aviz?</label>
                    </div>
                    <div id="secAviz2" class="hidden p-2 mb-3 border rounded bg-light">
                        <h6 class="fw-bold text-primary small m-0 mb-2">AVIZ 2</h6>
                        <div class="d-flex gap-2">
                            <div class="photo-box flex-fill bg-white" id="box_fileAviz2" onclick="triggerInput('fileAviz2', event)">
                                <div class="btn-preview-overlay" onclick="previewImage('fileAviz2', event)">VEZI</div>
                                <i class="fas fa-camera"></i> PozÄƒ Aviz 2
                                <input type="file" id="fileAviz2" hidden onchange="handleImageUpload(this, 'aviz2')">
                            </div>
                            <div class="photo-box flex-fill bg-white" id="box_fileTichet2" onclick="triggerInput('fileTichet2', event)">
                                <div class="btn-preview-overlay" onclick="previewImage('fileTichet2', event)">VEZI</div>
                                <i class="fas fa-ticket-alt"></i> Tichet 2
                                <input type="file" id="fileTichet2" hidden onchange="previewOnly(this)">
                            </div>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkDel" onchange="toggleDiv('secDel', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">DelegaÈ›ie?</label>
                    </div>
                    <div id="secDel" class="hidden p-3 bg-light rounded mb-3">
                        <div class="photo-box bg-white" id="box_fileDelegatie" onclick="triggerInput('fileDelegatie', event)">
                            <div class="btn-preview-overlay" onclick="previewImage('fileDelegatie', event)">VEZI</div>
                            <i class="fas fa-user-tag"></i> PozÄƒ DelegaÈ›ie
                            <input type="file" id="fileDelegatie" hidden onchange="handleImageUpload(this, 'delegatie')">
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkCMR" onchange="toggleDiv('secCMR', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">CMR?</label>
                    </div>
                    <div id="secCMR" class="hidden p-3 bg-light rounded mb-3">
                        <div class="photo-box bg-white" id="box_fileCMR" onclick="triggerInput('fileCMR', event)">
                            <div class="btn-preview-overlay" onclick="previewImage('fileCMR', event)">VEZI</div>
                            <i class="fas fa-file"></i> PozÄƒ CMR
                            <input type="file" id="fileCMR" hidden onchange="previewOnly(this)">
                        </div>
                    </div>
                </div>

                <div id="identificareContainer" class="hidden">
                    <div class="card p-3 border-0 shadow-sm mb-3">
                      <div class="form-section-title mt-0"><i class="far fa-user-circle me-2"></i>Identificare</div>
                      <div class="mb-3">
                         <label class="small text-muted fw-bold">È˜ofer</label>
                         <input type="text" class="form-control bg-light fw-bold" id="sofer" readonly>
                      </div>
                      <div class="mb-3">
                         <label class="small text-muted fw-bold">Auto</label>
                         <div class="autocomplete-wrapper"><input type="text" class="form-control fw-bold" id="numarAuto" placeholder="CautÄƒ..." autocomplete="off"><div id="list-numarAuto" class="autocomplete-list"></div></div>
                      </div>
                      <div class="mb-3">
                         <label class="small text-muted fw-bold">È˜antier (Punct Lucru)</label>
                         <div class="autocomplete-wrapper"><input type="text" class="form-control fw-bold" id="santier" autocomplete="off"><div id="list-santier" class="autocomplete-list"></div></div>
                      </div>
                    </div>
                </div>

                <div id="fullDetailsContainer" class="hidden">
                    <div class="alert alert-info small py-2"><i class="fas fa-magic me-1"></i> Date completate de AI (Online)</div>
                    
                    <div class="card p-3 border-0 shadow-sm mb-3">
                      <div class="form-section-title mt-0"><i class="far fa-calendar-alt me-2"></i>Detalii</div>
                      
                      <div class="row mb-2">
                          <div class="col-6"><label class="small text-muted fw-bold">Nr Aviz</label><input type="number" class="form-control fw-bold" id="numarAviz1"></div>
                          <div class="col-6"><label class="small text-muted fw-bold">Tone</label><input type="number" step="0.01" class="form-control fw-bold" id="toneAviz1"></div>
                      </div>

                      <div id="fieldsAviz2" class="hidden row mb-2 bg-light p-2 rounded">
                          <div class="col-12 small text-primary fw-bold mb-1">Aviz 2:</div>
                          <div class="col-6"><input type="number" class="form-control" id="numarAviz2" placeholder="Nr 2"></div>
                          <div class="col-6"><input type="number" step="0.01" class="form-control" id="toneAviz2" placeholder="Tone 2"></div>
                      </div>

                      <div id="fieldsDelegatie" class="hidden mb-2">
                          <label class="small text-muted fw-bold">Nr. DelegaÈ›ie</label>
                          <input type="number" class="form-control" id="numarDelegatie">
                      </div>

                      <hr class="my-3">

                      <div class="row">
                         <div class="col-6 mb-3"><label class="small text-muted fw-bold">Data CursÄƒ</label><input type="date" class="form-control" id="dataTransport"></div>
                         <input type="hidden" id="dataFacturare">
                      </div>
                      <div class="row">
                          <div class="col-6 mb-3"><label class="small text-muted fw-bold">ÃŽncÄƒrcare</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="locIncarcare"><div id="list-locIncarcare" class="autocomplete-list"></div></div></div>
                          <div class="col-6 mb-3"><label class="small text-muted fw-bold">DescÄƒrcare</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="locDescarcare"><div id="list-locDescarcare" class="autocomplete-list"></div></div></div>
                      </div>
                      <div class="mb-3"><label class="small text-muted fw-bold">Material</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="material"><div id="list-material" class="autocomplete-list"></div></div></div>
                    </div>
                </div>

                <div id="offlineMessage" class="hidden alert alert-warning text-center mt-3 shadow-sm border-0 rounded-4">
                    <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2 text-warning"></i><br>
                    <strong>Mod Offline</strong><br>
                    Pozele au fost salvate.<br>ApasÄƒ <b>SALVEAZÄ‚ CURSA</b>.
                </div>

                <div class="card p-3 border-0 shadow-sm mb-4 text-center">
                   <div class="btn-group w-100" role="group">
                      <input type="radio" class="btn-check" name="statusCursa" id="statusConf" value="CONFIRMATA" checked>
                      <label class="btn btn-outline-success" for="statusConf">CONFIRMATÄ‚</label>
                      <input type="radio" class="btn-check" name="statusCursa" id="statusNeconf" value="NECONFIRMATA">
                      <label class="btn btn-outline-danger" for="statusNeconf">NECONFIRMATÄ‚</label>
                   </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">SALVEAZÄ‚ CURSA</button>
                <div class="text-center mt-3 mb-5">
                   <a href="#" onclick="switchView('list')" class="text-muted text-decoration-none">AnuleazÄƒ</a>
                </div>
             </form>
         </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailsModal" tabindex="-1">
     <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
           <div class="modal-header border-0 bg-white">
              <h5 class="modal-title fw-bold text-dark">Detalii CursÄƒ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
           <div class="modal-body bg-white pt-2 px-4 pb-4" id="detailsBody"></div>
           <div class="modal-footer border-0 bg-light rounded-bottom-4 justify-content-between p-3">
              <button type="button" class="btn btn-outline-danger border-0 fw-bold" onclick="deleteCurrentTrip()"><i class="fas fa-trash-alt me-2"></i>È˜terge</button>
              <div>
                 <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="editCurrentTrip()"><i class="fas fa-pen me-2"></i> EditeazÄƒ</button>
              </div>
           </div>
        </div>
     </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/a/macros/logissupport.ro/s/AKfycbz6Nyardm3ixuhS7jvs1Xt8Rq1pIUrtw4a8QdeLTjM9Oz5YEFgbdPAH1nD3o7Kw3sJM/exec"; 
    const OFFLINE_KEY = "transport_offline_queue";

    let GLOBAL_DATA = {};
    let USER_INFO = { email: "", nume: "" };
    let FILE_CACHE = {};
    let USER_TRIPS = [];
    let CURRENT_TRIP_ID = null;
    let ACTIVE_SCAN_TARGET = null;

    window.onload = function() {
        try {
            showLoader("Se iniÈ›ializeazÄƒ...");
            try { if ("Notification" in window) Notification.requestPermission(); } catch(e) {}
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            const savedUser = localStorage.getItem('pabecon_user');
            if (savedUser) {
                try {
                    const u = JSON.parse(savedUser);
                    USER_INFO.email = u.email;
                    USER_INFO.nume = u.nume;
                    document.getElementById('userDisplay').innerText = u.nume;
                    document.getElementById('main-app').classList.remove('hidden');
                } catch (e) { throw new Error("Date utilizator corupte."); }
                
                if(navigator.onLine) {
                    fetch(`${SCRIPT_URL}?actiune=getTransportDropdowns`)
                      .then(r => r.json()).then(d => { GLOBAL_DATA = d; initApp(); })
                      .catch(() => initApp());
                } else initApp();
                updateNetworkStatus();
            } else {
                hideLoader(); alert("LogheazÄƒ-te prin Portal."); window.location.href = 'index.html';
            }
        } catch (e) { hideLoader(); alert("Eroare: " + e.message); }
    };

    function initApp() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const d = document.getElementById('dataTransport'); if(d) d.value = today;
            const f = document.getElementById('dataFacturare'); if(f) f.value = today;
            const s = document.getElementById('sofer'); if(s) s.value = USER_INFO.nume;
            
            setupAutocomplete('numarAuto', 'list-numarAuto', GLOBAL_DATA.auto || []);
            setupAutocomplete('santier', 'list-santier', GLOBAL_DATA.santiere || []);
            setupAutocomplete('locIncarcare', 'list-locIncarcare', GLOBAL_DATA.locatii || []);
            setupAutocomplete('locDescarcare', 'list-locDescarcare', GLOBAL_DATA.locatii || []);
            setupAutocomplete('material', 'list-material', GLOBAL_DATA.materiale || []);
            
            if(navigator.onLine) loadHistory(); else hideLoader();
            resetForm(); 
        } catch (e) { hideLoader(); console.error(e); }
    }

    // --- IMAGINI & PREVIEW ---
    function triggerInput(id, event) {
        // Prevenim click-ul dublu daca apasam pe butonul VEZI
        if(event.target.classList.contains('btn-preview-overlay')) return;
        document.getElementById(id).click();
    }

    function previewImage(fileId, event) {
        event.stopPropagation(); // Oprim triggerInput
        const b64 = FILE_CACHE[fileId];
        if(b64) {
            const win = window.open();
            win.document.write('<img src="data:image/jpeg;base64,' + b64 + '" style="width:100%">');
        } else {
            alert("Nicio pozÄƒ Ã®ncÄƒrcatÄƒ.");
        }
    }

    function handleImageUpload(input, type) {
        if (input.files.length === 0) return;
        const file = input.files[0];
        showLoader("Procesare...");
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = function() {
                const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                const max = 1600; let w = img.width; let h = img.height;
                if (w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
                const d = ctx.getImageData(0,0,w,h);
                for(let i=0; i<d.data.length; i+=4){
                   const avg = (d.data[i]+d.data[i+1]+d.data[i+2])/3;
                   const v = avg > 110 ? 255 : d.data[i]*0.8;
                   d.data[i]=v; d.data[i+1]=v; d.data[i+2]=v;
                }
                ctx.putImageData(d,0,0);
                const b64 = c.toDataURL('image/jpeg', 0.6).split(',')[1];

                let fileKey = "", boxId = "";
                if(type === 'aviz1') { fileKey = 'fileAviz1'; boxId = 'box_fileAviz1'; FILE_CACHE['aviz1_base64_temp'] = b64; }
                else if(type === 'aviz2') { fileKey = 'fileAviz2'; boxId = 'box_fileAviz2'; }
                else if(type === 'delegatie') { fileKey = 'fileDelegatie'; boxId = 'box_fileDelegatie'; }
                
                FILE_CACHE[fileKey] = b64;
                document.getElementById(boxId).classList.add('has-file');

                if(navigator.onLine) {
                    showLoader("AI...");
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ actiune: 'analizaTransport', image: b64 })
                    })
                    .then(r => r.json())
                    .then(res => fillData(res, type))
                    .catch((err) => { hideLoader(); alert("Eroare AI. CompleteazÄƒ manual."); revealAllFields(); });
                } else {
                    hideLoader();
                    alert("Mod Offline: PozÄƒ salvatÄƒ.");
                    document.getElementById('offlineMessage').classList.remove('hidden');
                }
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    }

    function fillData(res, type) {
        hideLoader();
        revealAllFields();
        document.getElementById('offlineMessage').classList.add('hidden');

        if(!res.success) { alert("AI: Nu am gÄƒsit date."); return; }
        let d = res.data;
        if (Array.isArray(d)) d = d[0];
        if (!d) return;

        if(d.auto && !document.getElementById('numarAuto').value) document.getElementById('numarAuto').value = d.auto.toUpperCase();
        if(d.data) { document.getElementById('dataTransport').value = d.data; document.getElementById('dataFacturare').value = d.data; }

        if(type === 'aviz1') {
            if(d.numar) document.getElementById('numarAviz1').value = d.numar;
            if(d.tone) document.getElementById('toneAviz1').value = d.tone;
            if(d.incarcare) document.getElementById('locIncarcare').value = d.incarcare;
            if(d.descarcare) document.getElementById('locDescarcare').value = d.descarcare;
            if(d.material) document.getElementById('material').value = d.material;
        } 
        else if(type === 'aviz2') {
            document.getElementById('fieldsAviz2').classList.remove('hidden'); 
            if(d.numar) document.getElementById('numarAviz2').value = d.numar;
            if(d.tone) document.getElementById('toneAviz2').value = d.tone;
        }
        else if(type === 'delegatie') {
            document.getElementById('fieldsDelegatie').classList.remove('hidden');
            if(d.numar) document.getElementById('numarDelegatie').value = d.numar;
        }
        alert("âœ… Completat!");
    }

    function revealAllFields() {
        document.getElementById('identificareContainer').classList.remove('hidden');
        document.getElementById('fullDetailsContainer').classList.remove('hidden');
    }

    function previewOnly(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = function(e) {
            const img = new Image(); img.onload = function(){
                const c=document.createElement('canvas'); const x=c.getContext('2d');
                let w=img.width; let h=img.height; if(w>1200){h*=1200/w;w=1200}
                c.width=w; c.height=h; x.drawImage(img,0,0,w,h);
                FILE_CACHE[input.id] = c.toDataURL('image/jpeg',0.7).split(',')[1];
                input.parentElement.classList.add('has-file');
            }; img.src = e.target.result;
        }; r.readAsDataURL(f);
    }

    function updateNetworkStatus() {
        const badge = document.getElementById('netStatus');
        const queue = getQueue();
        if (navigator.onLine) {
            badge.className = "badge bg-success rounded-pill d-flex align-items-center gap-1 shadow-sm";
            badge.innerHTML = `<i class="fas fa-wifi"></i> <span>ONLINE</span>`;
            if (queue.length > 0) processQueue();
        } else {
            badge.className = "badge bg-danger rounded-pill d-flex align-items-center gap-1 shadow-sm";
            badge.innerHTML = `<i class="fas fa-slash"></i> <span>OFFLINE (${queue.length})</span>`;
        }
        if(!navigator.onLine) document.getElementById('offlineMessage').classList.remove('hidden');
    }

    function toggleDiv(id, s) { const el = document.getElementById(id); if(s) el.classList.remove('hidden'); else el.classList.add('hidden'); }

    // --- SUBMIT (REPARAT OFFLINE) ---
    function handleSubmit(e) {
       e.preventDefault();
       
       // Validare Manuala pentru Offline (campurile 'required' nu merg daca sunt ascunse)
       if(!document.getElementById('santier').value) { alert("CompleteazÄƒ È˜antierul!"); return; }
       if(!document.getElementById('numarAuto').value) { alert("CompleteazÄƒ Auto!"); return; }
       
       // Verificare Poze
       if(navigator.onLine) {
           if(!document.getElementById('numarAviz1').value && !FILE_CACHE['fileAviz1']) {
               if(!FILE_CACHE['fileDelegatie']) { alert("Online: Ai nevoie de Aviz 1 sau DelegaÈ›ie!"); return; }
           }
       } else {
           // Offline e destul sa ai o poza
           if(!FILE_CACHE['fileAviz1'] && !FILE_CACHE['fileDelegatie']) { alert("Offline: FÄƒ o pozÄƒ la Aviz sau DelegaÈ›ie!"); return; }
       }

       const formData = {
          editId: document.getElementById('editId').value,
          dataTransport: document.getElementById('dataTransport').value || new Date().toISOString().split('T')[0],
          dataFacturare: document.getElementById('dataFacturare').value || new Date().toISOString().split('T')[0],
          sofer: document.getElementById('sofer').value,
          numarAuto: document.getElementById('numarAuto').value,
          santier: document.getElementById('santier').value,
          locIncarcare: document.getElementById('locIncarcare').value,
          locDescarcare: document.getElementById('locDescarcare').value,
          material: document.getElementById('material').value,
          numarAviz1: document.getElementById('numarAviz1').value || 0,
          toneAviz1: document.getElementById('toneAviz1').value || 0,
          pozaAviz1: FILE_CACHE['fileAviz1'] || '',
          pozaTichet1: FILE_CACHE['fileTichet1'] || '',
          pozaAviz1_base64_temp: FILE_CACHE['aviz1_base64_temp'] || '',
          hasAviz2: document.getElementById('checkAviz2').checked,
          numarAviz2: document.getElementById('numarAviz2').value || 0,
          toneAviz2: document.getElementById('toneAviz2').value || 0,
          pozaAviz2: FILE_CACHE['fileAviz2'] || '',
          pozaTichet2: FILE_CACHE['fileTichet2'] || '', 
          hasDelegatie: document.getElementById('checkDel').checked,
          numarDelegatie: document.getElementById('numarDelegatie').value,
          pozaDelegatie: FILE_CACHE['fileDelegatie'] || '',
          hasCMR: document.getElementById('checkCMR').checked,
          pozaCMR: FILE_CACHE['fileCMR'] || '',
          statusCursa: document.querySelector('input[name="statusCursa"]:checked').value
       };
       const payload = { actiune: 'saveTransport', formData: formData, email: USER_INFO.email };

       if (navigator.onLine) {
           showLoader("Se salveazÄƒ...");
           fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
           .then(r => r.json()).then(res => {
              hideLoader();
              if(res.success) { alert("âœ… Salvat!"); switchView('list'); }
              else alert("Eroare: " + res.message);
           }).catch(() => { saveToQueue(payload); alert("Conexiune slabÄƒ. Salvat Offline."); switchView('list'); });
       } else {
           saveToQueue(payload); alert("ðŸ’¾ Salvat Offline."); switchView('list');
       }
    }

    function getQueue() { return JSON.parse(localStorage.getItem(OFFLINE_KEY) || "[]"); }
    function saveToQueue(payload) {
        const queue = getQueue(); payload._tempId = Date.now(); queue.push(payload);
        localStorage.setItem(OFFLINE_KEY, JSON.stringify(queue)); updateNetworkStatus(); resetForm();
    }
    async function processQueue() {
        const queue = getQueue(); if (queue.length === 0) return;
        const syncMsg = document.getElementById('syncMessage');
        if(syncMsg) { syncMsg.classList.remove('hidden'); syncMsg.innerHTML = `<i class="fas fa-sync fa-spin"></i> Sync offline...`; }
        const item = queue[0];
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(item) }).then(r=>r.json());
            if(res.success) {
                queue.shift(); localStorage.setItem(OFFLINE_KEY, JSON.stringify(queue));
                if(item.formData && item.formData.santier) sendSyncNotification(item.formData.santier);
                if(queue.length > 0) processQueue();
                else { if(syncMsg) syncMsg.classList.add('hidden'); updateNetworkStatus(); alert("âœ… Sincronizare completÄƒ!"); loadHistory(); }
            }
        } catch(e) { if(syncMsg) syncMsg.classList.add('hidden'); }
    }

    function sendSyncNotification(santier) {
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") new Notification("Transport Sincronizat", { body: `Cursa ${santier} procesatÄƒ.`, icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png" });
    }
    function requestNotificationPermission() { if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission(); }

    function openAddScreen() { resetForm(); document.getElementById('editId').value = ""; switchView('add'); }
    function switchView(view) {
        document.getElementById('view-list').classList.toggle('hidden', view !== 'list');
        document.getElementById('view-add').classList.toggle('hidden', view !== 'add');
        document.getElementById('tab-list').classList.toggle('active', view === 'list');
        document.getElementById('tab-add').classList.toggle('active', view === 'add');
        if(view==='list' && navigator.onLine) loadHistory();
    }
    function resetForm() {
        document.getElementById('transportForm').reset();
        document.getElementById('editId').value = "";
        document.getElementById('sofer').value = USER_INFO.nume;
        const today = new Date().toISOString().split('T')[0];
        const dateEl = document.getElementById('dataTransport');
        if(dateEl) dateEl.value = today;
        FILE_CACHE = {};
        document.querySelectorAll('.photo-box').forEach(el => {
            el.classList.remove('has-file');
            // Resetam si overlay-ul de VEZI (css-ul il ascunde cand nu e has-file)
        });
        
        document.getElementById('identificareContainer').classList.add('hidden');
        document.getElementById('fullDetailsContainer').classList.add('hidden');
        document.getElementById('offlineMessage').classList.add('hidden');
        document.getElementById('fieldsAviz2').classList.add('hidden');
        document.getElementById('fieldsDelegatie').classList.add('hidden');
        toggleDiv('secAviz2', false); toggleDiv('secDel', false); toggleDiv('secCMR', false);
    }

    function loadHistory() {
       if(!navigator.onLine) return;
       showLoader("Se actualizeazÄƒ...");
       fetch(`${SCRIPT_URL}?actiune=getUserTrips&sofer=${encodeURIComponent(USER_INFO.nume)}`)
           .then(r => r.json()).then(trips => { hideLoader(); USER_TRIPS = trips; renderTrips(trips); })
           .catch(e => { hideLoader(); console.error(e); });
    }
    
    function renderTrips(trips) {
       const container = document.getElementById('trips-container'); container.innerHTML = '';
       if(!trips || !trips.length) { container.innerHTML = '<div class="text-center mt-5 text-muted">Nu existÄƒ date.</div>'; hideLoader(); return; }
       const grouped = {};
       trips.forEach(t => {
          let d = t.DATA_TRANSPORT; 
          try { if(typeof d==='object') d=new Date(d.value).toISOString(); else if(d.includes('T')) d=d.split('T')[0]; } catch(e){d="2024-01-01";}
          if(!d) d="2024-01-01";
          const y = d.split('-')[0]; const m = parseInt(d.split('-')[1]); 
          const mName = new Date(d).toLocaleDateString('ro-RO', { month: 'long' }).toUpperCase();
          const key = `${mName} ${y}`;
          if(!grouped[key]) grouped[key] = []; grouped[key].push(t);
       });

       let idx=0;
       for(const [mKey, mTrips] of Object.entries(grouped)) {
          idx++;
          const mDiv = document.createElement('div'); mDiv.className='accordion-item';
          mDiv.innerHTML = `<h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc${idx}"><span><i class="far fa-calendar me-2"></i> ${mKey}</span><i class="fas fa-chevron-down month-chevron"></i></button></h2><div id="acc${idx}" class="accordion-collapse collapse" data-bs-parent="#trips-container"><div class="accordion-body" id="body${idx}"></div></div>`;
          container.appendChild(mDiv);
          const body = mDiv.querySelector(`#body${idx}`);
          
          const bySite = {};
          mTrips.forEach(t => { const s = t.SANTIER||'FARA SANTIER'; if(!bySite[s]) bySite[s]=[]; bySite[s].push(t); });
          
          let sIdx=0;
          for(const [site, sTrips] of Object.entries(bySite)) {
              sIdx++;
              const sDiv = document.createElement('div'); sDiv.className='accordion mt-1';
              sDiv.innerHTML = `<button class="sub-accordion-btn collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sub${idx}_${sIdx}"><div class="site-name-container"><span class="text-dark fw-bold">${site}</span></div><div class="site-badge-container"><span class="site-badge">${sTrips.length}</span></div><div class="site-arrow-container"><i class="fas fa-chevron-down site-chev"></i></div></button><div id="sub${idx}_${sIdx}" class="accordion-collapse collapse"><div class="pt-2" id="list${idx}_${sIdx}"></div></div>`;
              body.appendChild(sDiv);
              const list = sDiv.querySelector(`#list${idx}_${sIdx}`);
              sTrips.forEach(t => {
                  let dispD = t.DATA_TRANSPORT; try { if(typeof dispD==='string'&&dispD.includes('T')) dispD=new Date(dispD).toLocaleDateString('ro'); else if (typeof dispD === 'object') dispD=new Date(dispD.value).toLocaleDateString('ro');} catch(e){}
                  const card = document.createElement('div'); card.className='trip-card';
                  card.onclick = () => openDetail(t.ID);
                  card.innerHTML = `<div class="trip-date">${dispD}</div><div class="trip-main">${t.SOFER}</div><div class="trip-sub">${t.MATERIAL || 'MarfÄƒ'} â€¢ ${t.NR_INMATRICULARE}</div><div class="trip-amount">${t.AVIZ_1_TONE || 0} t</div>`;
                  list.appendChild(card);
              });
          }
       }
       hideLoader();
    }
    
    // --- MODAL DETALII (ACTUALIZAT) ---
    function openDetail(id) { 
        CURRENT_TRIP_ID=id; const t=USER_TRIPS.find(x=>x.ID===id); if(!t)return;
        let dispD = t.DATA_TRANSPORT; try { if(typeof dispD==='string'&&dispD.includes('T')) dispD=new Date(dispD).toLocaleDateString('ro'); else if (typeof dispD === 'object') dispD=new Date(dispD.value).toLocaleDateString('ro'); } catch(e){}
        
        // Functie helper pt iconita de poza
        const photoBtn = (url) => url ? `<a href="${url}" target="_blank" class="btn-view-photo"><i class="fas fa-camera"></i></a>` : '';

        document.getElementById('detailsBody').innerHTML = `
            <div class="detail-section">
                <div class="detail-section-title">INFORMAÈšII GENERALE</div>
                <div class="detail-row"><span class="detail-label">DATÄ‚</span><span class="detail-val">${dispD}</span></div>
                <div class="detail-row"><span class="detail-label">È˜OFER</span><span class="detail-val">${t.SOFER}</span></div>
                <div class="detail-row"><span class="detail-label">AUTO</span><span class="detail-val">${t.NR_INMATRICULARE}</span></div>
                <div class="detail-row"><span class="detail-label">STATUS</span><span class="detail-val fw-bold ${t.STATUS_CURSA=='CONFIRMATA'?'text-success':'text-danger'}">${t.STATUS_CURSA||'-'}</span></div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">LOCAÈšIE & MARFÄ‚</div>
                <div class="detail-row"><span class="detail-label">È˜ANTIER</span><span class="detail-val">${t.SANTIER}</span></div>
                <div class="detail-row"><span class="detail-label">MATERIAL</span><span class="detail-val">${t.MATERIAL}</span></div>
                <div class="detail-row"><span class="detail-label">ÃŽNCÄ‚RCARE</span><span class="detail-val">${t.LOC_INCARCARE||'-'}</span></div>
                <div class="detail-row"><span class="detail-label">DESCÄ‚RCARE</span><span class="detail-val">${t.LOC_DESCARCARE||'-'}</span></div>
            </div>
            <div class="detail-section">
                <div class="detail-section-title">DOCUMENTE</div>
                
                <div class="detail-row">
                    <span class="detail-label">AVIZ 1</span>
                    <span class="detail-val">${t.AVIZ_1_NUMAR || '-'} (${t.AVIZ_1_TONE||0} t) ${photoBtn(t.AVIZ_1_POZA)}</span>
                </div>
                
                ${t.AVIZ_2==='DA' ? `
                <div class="detail-row">
                    <span class="detail-label">AVIZ 2</span>
                    <span class="detail-val">${t.AVIZ_2_NUMAR || '-'} (${t.AVIZ_2_TONE||0} t) ${photoBtn(t.AVIZ_2_POZA)}</span>
                </div>` : ''}
                
                <div class="detail-row"><span class="detail-label">DELEGAÈšIE</span><span class="detail-val">${t.DELEGATIE}</span></div>
                ${t.DELEGATIE==='DA' ? `<div class="detail-row"><span class="detail-label">NR. DELEGAÈšIE</span><span class="detail-val">${t.DELEGATIE_NUMAR||'-'} ${photoBtn(t.DELEGATIE_POZA)}</span></div>` : ''}
                
                <div class="detail-row"><span class="detail-label">CMR</span><span class="detail-val">${t.CMR} ${photoBtn(t['CMR POZA'])}</span></div>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('detailsModal')).show(); 
    }
    
    // --- EDIT (REPARAT) ---
    function editCurrentTrip() { 
        if(!navigator.onLine){alert("Doar Online");return;} 
        const t = USER_TRIPS.find(x => x.ID === CURRENT_TRIP_ID);
        if(!t) return;
        
        bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
        switchView('add');
        document.getElementById('editId').value = t.ID;
        
        // Afisam tot formularul pentru editare
        revealAllFields();
        
        // Populare campuri
        const setV = (id,v) => { if(document.getElementById(id)) document.getElementById(id).value = v || ''; };
        
        // Date
        let dt = t.DATA_TRANSPORT; if(typeof dt==='object') dt=dt.value; if(dt && dt.includes('T')) dt=dt.split('T')[0];
        setV('dataTransport', dt); setV('dataFacturare', dt);
        
        setV('sofer', t.SOFER);
        setV('numarAuto', t.NR_INMATRICULARE);
        setV('santier', t.SANTIER);
        setV('locIncarcare', t.LOC_INCARCARE);
        setV('locDescarcare', t.LOC_DESCARCARE);
        setV('material', t.MATERIAL);
        
        setV('numarAviz1', t.AVIZ_1_NUMAR);
        setV('toneAviz1', t.AVIZ_1_TONE);
        
        if(t.AVIZ_1_POZA) { FILE_CACHE['fileAviz1'] = t.AVIZ_1_POZA; document.getElementById('box_fileAviz1').classList.add('has-file'); }
        if(t.TICHET_1_CANTAR_POZA) { FILE_CACHE['fileTichet1'] = t.TICHET_1_CANTAR_POZA; document.getElementById('box_fileTichet1').classList.add('has-file'); }
        
        if(t.AVIZ_2 === 'DA') {
            document.getElementById('checkAviz2').checked = true;
            toggleDiv('secAviz2', true);
            document.getElementById('fieldsAviz2').classList.remove('hidden');
            setV('numarAviz2', t.AVIZ_2_NUMAR);
            setV('toneAviz2', t.AVIZ_2_TONE);
            if(t.AVIZ_2_POZA) { FILE_CACHE['fileAviz2'] = t.AVIZ_2_POZA; document.getElementById('box_fileAviz2').classList.add('has-file'); }
        }
        
        if(t.DELEGATIE === 'DA') {
            document.getElementById('checkDel').checked = true;
            toggleDiv('secDel', true);
            document.getElementById('fieldsDelegatie').classList.remove('hidden');
            setV('numarDelegatie', t.DELEGATIE_NUMAR);
            if(t.DELEGATIE_POZA) { FILE_CACHE['fileDelegatie'] = t.DELEGATIE_POZA; document.getElementById('box_fileDelegatie').classList.add('has-file'); }
        }
    }

    function deleteCurrentTrip() { if(!navigator.onLine)return; if(confirm("Stergi?")) { showLoader("..."); fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({actiune:'deleteTransport', id:CURRENT_TRIP_ID, email:USER_INFO.email})}).then(r=>r.json()).then(()=>{hideLoader(); bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide(); loadHistory();}); } }
    
    function setupAutocomplete(id, listId, data) { const inp=document.getElementById(id), list=document.getElementById(listId); inp.oninput=()=>{ const v=inp.value.toLowerCase(); list.innerHTML=''; if(!v){list.style.display='none';return;} const m=data.filter(x=>x&&x.toLowerCase().includes(v)); if(m.length){list.style.display='block'; m.forEach(x=>{const d=document.createElement('div');d.className='autocomplete-item';d.innerText=x;d.onclick=()=>{inp.value=x;list.style.display='none';};list.appendChild(d);});}else list.style.display='none'; }; document.onclick=e=>{if(e.target!==inp)list.style.display='none';}; }
    function toggleDiv(id,s) { const e=document.getElementById(id); if(s)e.classList.remove('hidden'); else e.classList.add('hidden'); }
    function showLoader(t) { document.getElementById('loaderText').innerText=t; document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }
  </script>
</body>
</html>
