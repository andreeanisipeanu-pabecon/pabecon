<!DOCTYPE html>
<html lang="ro">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Registru Transport</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary-gradient: linear-gradient(135deg, #0061f2 0%, #69a6ce 100%); --bg-light: #f8f9fa; --text-dark: #2d3748; --accent-color: #0061f2; }
    body { background-color: var(--bg-light); font-family: 'Poppins', sans-serif; color: var(--text-dark); padding-top: 140px; padding-bottom: 80px; margin: 0; }
    
    .fixed-header-wrapper { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background-color: var(--bg-light); box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    .app-header { background: var(--primary-gradient); color: white; padding: 15px 20px 50px; border-radius: 0 0 30px 30px; display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .user-pill { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); }
    .top-nav { display: flex; justify-content: center; gap: 10px; margin-top: -25px; margin-bottom: 10px; padding: 0 15px; }
    .nav-pill-btn { border: none; padding: 12px 0; border-radius: 50px; font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: 0.3s; flex: 1; text-align: center; max-width: 200px; cursor: pointer; }
    .nav-pill-btn.active { background: #2d3748; color: white; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    .nav-pill-btn:not(.active) { background: white; color: #4a5568; }
    
    .responsive-container { width: 100%; padding: 0 15px; margin: 0 auto; }
    @media (min-width: 768px) { .responsive-container { max-width: 95%; } }

    /* Cards & Lists */
    .trip-card { background: white; border-radius: 16px; padding: 12px 18px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border-left: 4px solid var(--accent-color); cursor: pointer; transition: 0.2s; }
    .trip-card:active { transform: scale(0.98); background: #fafafa; }
    .trip-date { font-size: 0.75rem; color: var(--accent-color); font-weight: 700; text-transform: uppercase; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
    .trip-main { font-weight: 700; font-size: 0.95rem; color: #1a202c; margin-bottom: 2px; }
    .trip-sub { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 5px; }
    .trip-amount { font-size: 0.95rem; font-weight: 700; color: #16a34a; position: absolute; top: 15px; right: 15px; }

    /* Form Styles */
    .form-container-width { max-width: 600px; margin: 0 auto; }
    .form-control { border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; }
    .form-section-title { color: var(--accent-color); font-weight: 700; margin: 20px 0 10px; font-size: 0.9rem; text-transform: uppercase; }
    .photo-box { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 15px; text-align: center; color: #a0aec0; background: #fff; cursor: pointer; transition: 0.2s; }
    .photo-box.has-file { border-color: #16a34a; color: #16a34a; background: #f0fdf4; font-weight: bold; }
    
    /* Autocomplete */
    .autocomplete-wrapper { position: relative; }
    .autocomplete-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border-radius: 12px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: none; }
    .autocomplete-item { padding: 12px; border-bottom: 1px solid #f7f7f7; cursor: pointer; }
    
    /* Utils */
    .hidden { display: none !important; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .btn-back { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 10px; cursor: pointer; }
    
    /* Accordion Custom */
    .accordion-button { border-radius: 15px !important; margin-bottom: 5px; font-weight: 600; color: #4a5568; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .accordion-button:not(.collapsed) { color: var(--accent-color); background: #eef5ff; }
    .accordion-item { border: none; background: transparent; margin-bottom: 10px; }
    .sub-accordion-btn { background: white; border: 1px solid #eef2f7; margin-top: 6px; border-radius: 12px !important; padding: 10px 15px; font-weight: 600; font-size: 0.85rem; color: #4a5568; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.02); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
    
    .site-badge { background: var(--primary-gradient); color: white; font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; font-weight: 700; }
    .site-arrow-container { justify-self: end; }
    .fa-chevron-down.site-chev { transition: transform 0.3s; }
    .sub-accordion-btn[aria-expanded="true"] .site-chev { transform: rotate(180deg); color: var(--accent-color); }
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold text-muted" id="loaderText">Se iniÈ›ializeazÄƒ...</div>
  </div>

  <div id="main-app" class="hidden">
    <div class="fixed-header-wrapper">
        <div class="app-header">
          <div class="d-flex align-items-center">
              <button class="btn-back" onclick="window.location.href='index.html'"><i class="fa-solid fa-arrow-left"></i></button>
              <div class="header-title ms-2"><i class="fas fa-truck-moving"></i> Transport</div>
          </div>
          <div class="d-flex align-items-center gap-2">
              <div id="netStatus" class="badge bg-success rounded-pill d-flex align-items-center gap-1 shadow-sm" style="font-size:0.75rem;">
                  <i class="fas fa-wifi"></i> <span>ONLINE</span>
              </div>
              <div class="user-pill"><i class="fas fa-user-circle"></i> <span id="userDisplay">User</span></div>
          </div>
        </div>
        <div class="top-nav">
           <button class="nav-pill-btn active" id="tab-list" onclick="switchView('list')">Istoric</button>
           <button class="nav-pill-btn" id="tab-add" onclick="openAddScreen()">AdaugÄƒ</button>
        </div>
        <div id="syncMessage" class="bg-warning text-dark text-center py-1 small fw-bold hidden"></div>
    </div>

    <div class="responsive-container">
      <div id="view-list">
        <div class="text-end mb-3 mt-3">
             <button type="button" class="btn btn-sm rounded-pill btn-light border fw-bold text-secondary" onclick="loadHistory()">
                <i class="fa-solid fa-rotate me-1"></i> ActualizeazÄƒ
             </button>
        </div>
        <div id="trips-container" class="pb-5"></div>
      </div>

      <div id="view-add" class="hidden pb-5">
         <div class="form-container-width">
             <form id="transportForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <input type="file" id="universalCameraInput" accept="image/*" style="display:none" onchange="processScanResult()">
                
                <div class="card p-3 border-0 shadow-sm mb-3">
                  <div class="form-section-title mt-0"><i class="fa-solid fa-user-tag me-2"></i>Identificare</div>
                  <div class="mb-3">
                     <label class="small text-muted fw-bold">È˜ofer</label>
                     <input type="text" class="form-control bg-light fw-bold" id="sofer" readonly>
                  </div>
                  <div class="mb-3">
                     <label class="small text-muted fw-bold">Auto</label>
                     <div class="autocomplete-wrapper"><input type="text" class="form-control fw-bold" id="numarAuto" placeholder="CautÄƒ..." required autocomplete="off"><div id="list-numarAuto" class="autocomplete-list"></div></div>
                  </div>
                  <div class="mb-3">
                     <label class="small text-muted fw-bold">È˜antier (Punct Lucru)</label>
                     <div class="autocomplete-wrapper"><input type="text" class="form-control fw-bold" id="santier" required autocomplete="off"><div id="list-santier" class="autocomplete-list"></div></div>
                  </div>
                </div>

                <div id="fullDetailsContainer">
                    <div class="alert alert-info small py-2"><i class="fas fa-magic me-1"></i> Date completate de AI (Online)</div>
                    
                    <div class="card p-3 border-0 shadow-sm mb-3">
                      <div class="row">
                         <div class="col-6 mb-3"><label class="small text-muted fw-bold">Data CursÄƒ</label><input type="date" class="form-control" id="dataTransport" required></div>
                         <input type="hidden" id="dataFacturare">
                      </div>
                      <div class="row">
                          <div class="col-6 mb-3"><label class="small text-muted fw-bold">ÃŽncÄƒrcare</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="locIncarcare"><div id="list-locIncarcare" class="autocomplete-list"></div></div></div>
                          <div class="col-6 mb-3"><label class="small text-muted fw-bold">DescÄƒrcare</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="locDescarcare"><div id="list-locDescarcare" class="autocomplete-list"></div></div></div>
                      </div>
                      <div class="mb-3"><label class="small text-muted fw-bold">Material</label><div class="autocomplete-wrapper"><input type="text" class="form-control" id="material"><div id="list-material" class="autocomplete-list"></div></div></div>
                    </div>
                </div>

                <div class="card p-3 border-0 shadow-sm mb-3">
                    <div class="form-section-title d-flex justify-content-between align-items-center mt-0">
                        <span><i class="fas fa-file-invoice me-2"></i>Documente</span>
                    </div>

                    <div class="p-2 mb-3 border rounded bg-light position-relative">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold text-primary small m-0">AVIZ 1</h6>
                            <button type="button" class="btn btn-sm btn-primary rounded-pill fw-bold px-3" onclick="startScan('aviz1')"><i class="fas fa-camera me-1"></i> SCAN</button>
                        </div>
                        
                        <div id="fieldsAviz1">
                            <div class="row mb-2">
                                <div class="col-6"><label class="small text-muted fw-bold">Nr Aviz</label><input type="number" class="form-control fw-bold" id="numarAviz1"></div>
                                <div class="col-6"><label class="small text-muted fw-bold">Tone</label><input type="number" step="0.01" class="form-control fw-bold" id="toneAviz1"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <div class="photo-box flex-fill bg-white" id="box_fileAviz1" onclick="triggerPhoto('fileAviz1')"><i class="fas fa-image"></i> PozÄƒ<input type="file" id="fileAviz1" hidden onchange="previewFile(this)"></div>
                            <div class="photo-box flex-fill bg-white" onclick="triggerPhoto('fileTichet1')"><i class="fas fa-ticket-alt"></i> Tichet<input type="file" id="fileTichet1" hidden onchange="previewFile(this)"></div>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkAviz2" onchange="toggleDiv('secAviz2', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">Al doilea aviz?</label>
                    </div>
                    <div id="secAviz2" class="hidden p-2 mb-3 border rounded bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold text-primary small m-0">AVIZ 2</h6>
                            <button type="button" class="btn btn-sm btn-primary rounded-pill fw-bold px-3" onclick="startScan('aviz2')"><i class="fas fa-camera me-1"></i> SCAN</button>
                        </div>
                        <div id="fieldsAviz2" class="row mb-2">
                            <div class="col-6"><input type="number" class="form-control" id="numarAviz2" placeholder="Nr"></div>
                            <div class="col-6"><input type="number" step="0.01" class="form-control" id="toneAviz2" placeholder="Tone"></div>
                        </div>
                        <div class="photo-box bg-white" id="box_fileAviz2" onclick="triggerPhoto('fileAviz2')"><i class="fas fa-image"></i> PozÄƒ Aviz 2<input type="file" id="fileAviz2" hidden onchange="previewFile(this)"></div>
                    </div>

                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkDel" onchange="toggleDiv('secDel', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">DelegaÈ›ie?</label>
                    </div>
                    <div id="secDel" class="hidden p-3 bg-light rounded mb-3">
                        <div class="d-flex justify-content-end mb-2">
                             <button type="button" class="btn btn-sm btn-primary rounded-pill fw-bold px-3" onclick="startScan('delegatie')"><i class="fas fa-camera me-1"></i> SCAN</button>
                        </div>
                        <div id="fieldsDelegatie"><input type="text" class="form-control mb-2" id="numarDelegatie" placeholder="NumÄƒr DelegaÈ›ie"></div>
                        <div class="photo-box bg-white" id="box_fileDelegatie" onclick="triggerPhoto('fileDelegatie')"><i class="fas fa-user-tag"></i> PozÄƒ DelegaÈ›ie<input type="file" id="fileDelegatie" hidden onchange="previewFile(this)"></div>
                    </div>
                    
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="checkCMR" onchange="toggleDiv('secCMR', this.checked)">
                        <label class="form-check-label fw-bold small text-muted">CMR?</label>
                    </div>
                    <div id="secCMR" class="hidden p-3 bg-light rounded mb-3">
                        <div class="photo-box bg-white" onclick="triggerPhoto('fileCMR')"><i class="fas fa-file"></i> Poza CMR<input type="file" id="fileCMR" hidden onchange="previewFile(this)"></div>
                    </div>
                </div>

                <div id="offlineMessage" class="hidden alert alert-warning text-center mt-3 shadow-sm border-0 rounded-4">
                    <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2 text-warning"></i><br>
                    <strong>Mod Offline</strong><br>
                    Doar scaneazÄƒ (fÄƒ pozÄƒ) È™i apasÄƒ <b>SALVEAZÄ‚</b>.<br>
                    AI-ul va completa automat datele cÃ¢nd revine internetul.
                </div>

                <div class="card p-3 border-0 shadow-sm mb-4 text-center">
                   <div class="btn-group w-100" role="group">
                      <input type="radio" class="btn-check" name="statusCursa" id="statusConf" value="CONFIRMATA" checked>
                      <label class="btn btn-outline-success" for="statusConf">CONFIRMATÄ‚</label>
                      <input type="radio" class="btn-check" name="statusCursa" id="statusNeconf" value="NECONFIRMATA">
                      <label class="btn btn-outline-danger" for="statusNeconf">NECONFIRMATÄ‚</label>
                   </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow" style="background: var(--primary-gradient); border:none;">SALVEAZÄ‚ CURSA</button>
                <div class="text-center mt-3 mb-5">
                   <a href="#" onclick="switchView('list')" class="text-muted text-decoration-none">AnuleazÄƒ</a>
                </div>
             </form>
         </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailsModal" tabindex="-1">
     <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
           <div class="modal-header border-0 bg-white">
              <h5 class="modal-title fw-bold text-dark">Detalii CursÄƒ</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
           <div class="modal-body bg-white pt-2 px-4 pb-4" id="detailsBody"></div>
           <div class="modal-footer border-0 bg-light rounded-bottom-4 justify-content-between p-3">
              <button type="button" class="btn btn-outline-danger border-0 fw-bold" onclick="deleteCurrentTrip()"><i class="fas fa-trash-alt me-2"></i>È˜terge</button>
              <div>
                 <button class="btn btn-light rounded-pill me-2 border" onclick="showPhotos()"><i class="fas fa-eye text-secondary me-1"></i> Poze</button>
                 <button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="editCurrentTrip()"><i class="fas fa-pen me-2"></i> EditeazÄƒ</button>
              </div>
           </div>
        </div>
     </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // 1. CONFIGURARE
    // ==========================================
    // !!! VERIFICÄ‚ SÄ‚ FIE LINK-UL TÄ‚U ACTUALIZAT DIN DEPLOY !!!
    const SCRIPT_URL = "https://script.google.com/a/macros/logissupport.ro/s/AKfycbz6Nyardm3ixuhS7jvs1Xt8Rq1pIUrtw4a8QdeLTjM9Oz5YEFgbdPAH1nD3o7Kw3sJM/exec"; 
    const OFFLINE_KEY = "transport_offline_queue";

    let GLOBAL_DATA = {};
    let USER_INFO = { email: "", nume: "" };
    let FILE_CACHE = {};
    let USER_TRIPS = [];
    let CURRENT_TRIP_ID = null;
    let ACTIVE_SCAN_TARGET = null;

    // ==========================================
    // 2. INITIALIZARE (CU PROTECÈšIE LA EROARE)
    // ==========================================
    window.onload = function() {
        try {
            showLoader("Se iniÈ›ializeazÄƒ...");
            
            try { if ("Notification" in window) Notification.requestPermission(); } catch(e) { console.log("Fara notificari"); }

            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            const savedUser = localStorage.getItem('pabecon_user');
            if (savedUser) {
                try {
                    const u = JSON.parse(savedUser);
                    USER_INFO.email = u.email;
                    USER_INFO.nume = u.nume;
                    document.getElementById('userDisplay').innerText = u.nume;
                    document.getElementById('main-app').classList.remove('hidden');
                } catch (jsonErr) {
                    throw new Error("Date utilizator corupte.");
                }
                
                if(navigator.onLine) {
                    fetch(`${SCRIPT_URL}?actiune=getTransportDropdowns`)
                      .then(r => r.json())
                      .then(d => { GLOBAL_DATA = d; initApp(); })
                      .catch(err => { console.error("Err dropdowns:", err); initApp(); });
                } else {
                    initApp(); 
                }
                updateNetworkStatus();
            } else {
                hideLoader();
                alert("Nu eÈ™ti logat! Vei fi redirecÈ›ionat.");
                window.location.href = 'index.html';
            }
        } catch (globalErr) {
            hideLoader();
            alert("Eroare CriticÄƒ: " + globalErr.message);
        }
    };

    function initApp() {
        try {
            const today = new Date().toISOString().split('T')[0];
            const dateEl = document.getElementById('dataTransport');
            const factEl = document.getElementById('dataFacturare');
            const soferEl = document.getElementById('sofer');

            if(dateEl) dateEl.value = today;
            if(factEl) factEl.value = today;
            if(soferEl) soferEl.value = USER_INFO.nume;
            
            setupAutocomplete('numarAuto', 'list-numarAuto', GLOBAL_DATA.auto || []);
            setupAutocomplete('santier', 'list-santier', GLOBAL_DATA.santiere || []);
            setupAutocomplete('locIncarcare', 'list-locIncarcare', GLOBAL_DATA.locatii || []);
            setupAutocomplete('locDescarcare', 'list-locDescarcare', GLOBAL_DATA.locatii || []);
            setupAutocomplete('material', 'list-material', GLOBAL_DATA.materiale || []);
            
            if(navigator.onLine) loadHistory();
            else hideLoader();
            
            updateFormVisibility();
        } catch (e) {
            hideLoader();
            console.error(e);
            alert("Eroare initApp: " + e.message);
        }
    }

    // ==========================================
    // 3. UI MANAGEMENT
    // ==========================================
    function updateNetworkStatus() {
        const badge = document.getElementById('netStatus');
        const queue = getQueue();
        const isOnline = navigator.onLine;
        
        if (badge) {
            if (isOnline) {
                badge.className = "badge bg-success rounded-pill d-flex align-items-center gap-1 shadow-sm";
                badge.innerHTML = `<i class="fas fa-wifi"></i> <span>ONLINE</span>`;
                if (queue.length > 0) processQueue();
            } else {
                badge.className = "badge bg-danger rounded-pill d-flex align-items-center gap-1 shadow-sm";
                badge.innerHTML = `<i class="fas fa-slash"></i> <span>OFFLINE (${queue.length})</span>`;
            }
        }
        updateFormVisibility();
    }

    function updateFormVisibility() {
        const fullDetails = document.getElementById('fullDetailsContainer');
        const fieldsAviz1 = document.getElementById('fieldsAviz1');
        const fieldsAviz2 = document.getElementById('fieldsAviz2');
        const fieldsDel = document.getElementById('fieldsDelegatie');
        const msg = document.getElementById('offlineMessage');
        
        if (!fullDetails) return;

        if (navigator.onLine) {
            fullDetails.classList.remove('hidden');
            fieldsAviz1.classList.remove('hidden');
            fieldsAviz2.classList.remove('hidden');
            fieldsDel.classList.remove('hidden');
            msg.classList.add('hidden');
        } else {
            fullDetails.classList.add('hidden');
            fieldsAviz1.classList.add('hidden');
            fieldsAviz2.classList.add('hidden');
            fieldsDel.classList.add('hidden');
            msg.classList.remove('hidden');
        }
    }

    // ==========================================
    // 4. LOGICA SCANARE & AI
    // ==========================================
    function startScan(target) {
        ACTIVE_SCAN_TARGET = target;
        document.getElementById('universalCameraInput').click();
    }

    function processScanResult() {
        const input = document.getElementById('universalCameraInput');
        if (input.files.length === 0) return;
        const file = input.files[0];
        
        showLoader("Procesare imagine...");
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = function() {
                const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                const max = 1600; let w = img.width; let h = img.height;
                if (w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}}
                c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
                
                const d = ctx.getImageData(0,0,w,h);
                for(let i=0; i<d.data.length; i+=4){
                   const avg = (d.data[i]+d.data[i+1]+d.data[i+2])/3;
                   const v = avg > 110 ? 255 : d.data[i]*0.8;
                   d.data[i]=v; d.data[i+1]=v; d.data[i+2]=v;
                }
                ctx.putImageData(d,0,0);
                
                const b64 = c.toDataURL('image/jpeg', 0.6).split(',')[1];
                
                let fileKey = ""; let boxId = "";
                if (ACTIVE_SCAN_TARGET === 'aviz1') { fileKey='fileAviz1'; boxId='box_fileAviz1'; }
                else if (ACTIVE_SCAN_TARGET === 'aviz2') { fileKey='fileAviz2'; boxId='box_fileAviz2'; }
                else if (ACTIVE_SCAN_TARGET === 'delegatie') { fileKey='fileDelegatie'; boxId='box_fileDelegatie'; }
                
                if(fileKey) {
                    FILE_CACHE[fileKey] = b64;
                    const el = document.getElementById(boxId);
                    if(el) el.classList.add('has-file');
                    if (ACTIVE_SCAN_TARGET === 'aviz1') FILE_CACHE['aviz1_base64_temp'] = b64;
                }

                if(navigator.onLine) {
                    showLoader("AnalizÄƒ AI...");
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ actiune: 'analizaTransport', image: b64 })
                    })
                    .then(r => r.json()).then(res => fillScannedData(res))
                    .catch((err) => { hideLoader(); alert("Eroare AI: " + err); });
                } else {
                    hideLoader();
                    alert("ðŸ“¸ PozÄƒ salvatÄƒ local. Sync automat la revenirea netului.");
                }
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
        input.value = '';
    }

    function fillScannedData(res) {
        hideLoader();
        if(!res.success) { alert("Nu s-au putut extrage datele."); return; }
        const d = res.data;
        
        document.getElementById('fullDetailsContainer').classList.remove('hidden');
        document.getElementById('fieldsAviz1').classList.remove('hidden');
        document.getElementById('fieldsAviz2').classList.remove('hidden');
        document.getElementById('fieldsDelegatie').classList.remove('hidden');
        document.getElementById('offlineMessage').classList.add('hidden');

        if(d.auto) document.getElementById('numarAuto').value = d.auto.toUpperCase();
        if(d.data) { document.getElementById('dataTransport').value = d.data; document.getElementById('dataFacturare').value = d.data; }
        
        if (ACTIVE_SCAN_TARGET === 'aviz1') {
            if(d.numar) document.getElementById('numarAviz1').value = d.numar;
            if(d.tone) document.getElementById('toneAviz1').value = d.tone;
            if(d.incarcare) document.getElementById('locIncarcare').value = d.incarcare;
            if(d.descarcare) document.getElementById('locDescarcare').value = d.descarcare;
            if(d.material) document.getElementById('material').value = d.material;
        } 
        else if (ACTIVE_SCAN_TARGET === 'aviz2') {
            if(d.numar) document.getElementById('numarAviz2').value = d.numar;
            if(d.tone) document.getElementById('toneAviz2').value = d.tone;
        }
        else if (ACTIVE_SCAN_TARGET === 'delegatie') {
            if(d.numar) document.getElementById('numarDelegatie').value = d.numar;
        }
        alert("âœ… Date extrase cu succes!");
    }

    // ==========================================
    // 5. SUBMIT & SYNC
    // ==========================================
    function handleSubmit(e) {
       e.preventDefault();
       
       if(!document.getElementById('santier').value || !document.getElementById('numarAuto').value) {
           alert("CompleteazÄƒ È˜antierul È™i Auto!"); return;
       }
       if(navigator.onLine && !document.getElementById('numarAviz1').value && !FILE_CACHE['fileAviz1']) {
           if(!FILE_CACHE['fileDelegatie']) { alert("Online: Ai nevoie de Aviz 1 sau DelegaÈ›ie!"); return; }
       }

       const formData = {
          editId: document.getElementById('editId').value,
          dataTransport: document.getElementById('dataTransport').value || new Date().toISOString().split('T')[0],
          dataFacturare: document.getElementById('dataFacturare').value || new Date().toISOString().split('T')[0],
          sofer: document.getElementById('sofer').value,
          numarAuto: document.getElementById('numarAuto').value,
          santier: document.getElementById('santier').value,
          locIncarcare: document.getElementById('locIncarcare').value,
          locDescarcare: document.getElementById('locDescarcare').value,
          material: document.getElementById('material').value,
          numarAviz1: document.getElementById('numarAviz1').value || 0,
          toneAviz1: document.getElementById('toneAviz1').value || 0,
          pozaAviz1: FILE_CACHE['fileAviz1'] || '',
          pozaTichet1: FILE_CACHE['fileTichet1'] || '',
          pozaAviz1_base64_temp: FILE_CACHE['aviz1_base64_temp'] || '',
          hasAviz2: document.getElementById('checkAviz2').checked,
          numarAviz2: document.getElementById('numarAviz2').value || 0,
          toneAviz2: document.getElementById('toneAviz2').value || 0,
          pozaAviz2: FILE_CACHE['fileAviz2'] || '',
          hasCMR: document.getElementById('checkCMR').checked,
          pozaCMR: FILE_CACHE['fileCMR'] || '',
          hasDelegatie: document.getElementById('checkDel').checked,
          numarDelegatie: document.getElementById('numarDelegatie').value,
          pozaDelegatie: FILE_CACHE['fileDelegatie'] || '',
          statusCursa: document.querySelector('input[name="statusCursa"]:checked').value
       };

       const payload = { actiune: 'saveTransport', formData: formData, email: USER_INFO.email };

       if (navigator.onLine) {
           showLoader("Se salveazÄƒ...");
           fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
           .then(r => r.json()).then(res => {
              hideLoader();
              if(res.success) { alert("âœ… Salvat!"); switchView('list'); }
              else alert("Eroare: " + res.message);
           })
           .catch(() => { saveToQueue(payload); alert("Conexiune slabÄƒ. Salvat Offline."); switchView('list'); });
       } else {
           saveToQueue(payload);
           alert("ðŸ’¾ Salvat Offline. Se va trimite automat.");
           switchView('list');
       }
    }

    function getQueue() { return JSON.parse(localStorage.getItem(OFFLINE_KEY) || "[]"); }
    function saveToQueue(payload) {
        const queue = getQueue();
        payload._tempId = Date.now();
        queue.push(payload);
        localStorage.setItem(OFFLINE_KEY, JSON.stringify(queue));
        updateNetworkStatus();
        resetForm();
    }

    async function processQueue() {
        const queue = getQueue();
        if (queue.length === 0) return;
        const syncMsg = document.getElementById('syncMessage');
        if(syncMsg) { syncMsg.classList.remove('hidden'); syncMsg.innerHTML = `<i class="fas fa-sync fa-spin"></i> Procesare offline...`; }
        const item = queue[0];
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(item) }).then(r=>r.json());
            if(res.success) {
                queue.shift();
                localStorage.setItem(OFFLINE_KEY, JSON.stringify(queue));
                if(item.formData && item.formData.santier) sendSyncNotification(item.formData.santier);
                if(queue.length > 0) processQueue();
                else {
                    if(syncMsg) syncMsg.classList.add('hidden');
                    updateNetworkStatus();
                    alert("âœ… Toate datele au fost sincronizate!");
                    loadHistory();
                }
            } else {
                if(syncMsg) syncMsg.innerText = "Eroare sync...";
                setTimeout(()=>{if(syncMsg)syncMsg.classList.add('hidden')},3000);
            }
        } catch(e) { if(syncMsg) syncMsg.classList.add('hidden'); }
    }

    function sendSyncNotification(santier) {
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") {
            new Notification("Transport Sincronizat", { body: `Cursa ${santier} procesatÄƒ.`, icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png" });
        }
    }
    function requestNotificationPermission() { if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission(); }

    function openAddScreen() { resetForm(); document.getElementById('editId').value = ""; switchView('add'); }
    
    function switchView(view) {
        document.getElementById('view-list').classList.toggle('hidden', view !== 'list');
        document.getElementById('view-add').classList.toggle('hidden', view !== 'add');
        document.getElementById('tab-list').classList.toggle('active', view === 'list');
        document.getElementById('tab-add').classList.toggle('active', view === 'add');
        if(view==='list' && navigator.onLine) loadHistory();
    }
    
    function resetForm() {
        document.getElementById('transportForm').reset();
        document.getElementById('editId').value = "";
        document.getElementById('sofer').value = USER_INFO.nume;
        const today = new Date().toISOString().split('T')[0];
        const dateEl = document.getElementById('dataTransport');
        if(dateEl) dateEl.value = today;
        FILE_CACHE = {};
        document.querySelectorAll('.photo-box').forEach(el => el.classList.remove('has-file'));
        updateFormVisibility();
    }

    // === FUNCTIA CARE LIPSEA (LOAD HISTORY) ===
    function loadHistory() {
       if(!navigator.onLine) return;
       showLoader("Se actualizeazÄƒ...");
       fetch(`${SCRIPT_URL}?actiune=getUserTrips&sofer=${encodeURIComponent(USER_INFO.nume)}`)
           .then(r => r.json())
           .then(trips => {
              hideLoader();
              USER_TRIPS = trips;
              renderTrips(trips);
           })
           .catch(e => { 
               hideLoader(); 
               console.error(e);
               // Nu dam alert, doar ascundem loader-ul, poate fi doar retea lenta
           });
    }
    
    function renderTrips(trips) {
       const container = document.getElementById('trips-container'); container.innerHTML = '';
       if(!trips || !trips.length) { container.innerHTML = '<div class="text-center mt-5 text-muted">Nu existÄƒ date.</div>'; hideLoader(); return; }
       
       const grouped = {};
       trips.forEach(t => {
          let d = t.DATA_TRANSPORT; 
          try { if(typeof d==='object') d=new Date(d.value).toISOString(); else if(d.includes('T')) d=d.split('T')[0]; } catch(e){d="2024-01-01";}
          if(!d) d="2024-01-01";
          const y = d.split('-')[0]; const m = parseInt(d.split('-')[1]);
          const key = (["","IAN","FEB","MAR","APR","MAI","IUN","IUL","AUG","SEP","OCT","NOI","DEC"][m]||"UNK") + " " + y;
          if(!grouped[key]) grouped[key] = []; grouped[key].push(t);
       });

       let idx=0;
       for(const [mKey, mTrips] of Object.entries(grouped)) {
          idx++;
          const mDiv = document.createElement('div'); mDiv.className='accordion-item';
          mDiv.innerHTML = `<h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acc${idx}"><span><i class="far fa-calendar me-2"></i> ${mKey}</span><i class="fas fa-chevron-down month-chevron"></i></button></h2><div id="acc${idx}" class="accordion-collapse collapse" data-bs-parent="#trips-container"><div class="accordion-body" id="body${idx}"></div></div>`;
          container.appendChild(mDiv);
          const body = mDiv.querySelector(`#body${idx}`);
          
          const bySite = {};
          mTrips.forEach(t => { const s = t.SANTIER||'FARA SANTIER'; if(!bySite[s]) bySite[s]=[]; bySite[s].push(t); });
          
          let sIdx=0;
          for(const [site, sTrips] of Object.entries(bySite)) {
              sIdx++;
              const sDiv = document.createElement('div'); sDiv.className='accordion mt-1';
              sDiv.innerHTML = `<button class="sub-accordion-btn collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sub${idx}_${sIdx}"><div class="site-name-container"><span class="text-dark fw-bold">${site}</span></div><div class="site-badge-container"><span class="site-badge">${sTrips.length}</span></div><div class="site-arrow-container"><i class="fas fa-chevron-down site-chev"></i></div></button><div id="sub${idx}_${sIdx}" class="accordion-collapse collapse"><div class="pt-2" id="list${idx}_${sIdx}"></div></div>`;
              body.appendChild(sDiv);
              const list = sDiv.querySelector(`#list${idx}_${sIdx}`);
              
              sTrips.forEach(t => {
                  let dispD = t.DATA_TRANSPORT; try { if(typeof dispD==='string'&&dispD.includes('T')) dispD=new Date(dispD).toLocaleDateString('ro'); else if (typeof dispD === 'object') dispD=new Date(dispD.value).toLocaleDateString('ro');} catch(e){}
                  const card = document.createElement('div'); card.className='trip-card';
                  card.onclick = () => openDetail(t.ID);
                  card.innerHTML = `<div class="trip-date">${dispD}</div><div class="trip-main">${t.SOFER}</div><div class="trip-sub">${t.MATERIAL || 'MarfÄƒ'} â€¢ ${t.NR_INMATRICULARE}</div><div class="trip-amount">${t.AVIZ_1_TONE || 0} t</div>`;
                  list.appendChild(card);
              });
          }
       }
       hideLoader();
    }
    
    function openDetail(id) { 
        CURRENT_TRIP_ID=id; 
        const t=USER_TRIPS.find(x=>x.ID===id); 
        if(!t)return;
        let dispD = t.DATA_TRANSPORT; try { if(typeof dispD==='string'&&dispD.includes('T')) dispD=new Date(dispD).toLocaleDateString('ro'); else if (typeof dispD === 'object') dispD=new Date(dispD.value).toLocaleDateString('ro'); } catch(e){}
        document.getElementById('detailsBody').innerHTML = `<div class="detail-section"><div class="detail-section-title">General</div><div class="detail-row"><span class="detail-label">DATÄ‚</span><span class="detail-val">${dispD}</span></div><div class="detail-row"><span class="detail-label">È˜OFER</span><span class="detail-val">${t.SOFER}</span></div><div class="detail-row"><span class="detail-label">AUTO</span><span class="detail-val">${t.NR_INMATRICULARE}</span></div></div><div class="detail-section"><div class="detail-section-title">MarfÄƒ</div><div class="detail-row"><span class="detail-label">È˜ANTIER</span><span class="detail-val">${t.SANTIER}</span></div><div class="detail-row"><span class="detail-label">MATERIAL</span><span class="detail-val">${t.MATERIAL}</span></div><div class="detail-row"><span class="detail-label">TONE</span><span class="detail-val fw-bold text-success">${t.AVIZ_1_TONE}</span></div></div><div class="detail-section"><div class="detail-section-title">Doc</div><div class="detail-row"><span class="detail-label">AVIZ 1</span><span class="detail-val">${t.AVIZ_1_NUMAR || '-'}</span></div><div class="detail-row"><span class="detail-label">DELEGAÈšIE</span><span class="detail-val">${t.DELEGATIE_NUMAR || '-'}</span></div></div>`;
        new bootstrap.Modal(document.getElementById('detailsModal')).show(); 
    }
    
    function editCurrentTrip() { if(!navigator.onLine){alert("Doar Online");return;} alert("Editare indisponibila momentan."); }
    function deleteCurrentTrip() { if(!navigator.onLine)return; if(confirm("Stergi?")) { showLoader("..."); fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({actiune:'deleteTransport', id:CURRENT_TRIP_ID, email:USER_INFO.email})}).then(r=>r.json()).then(()=>{hideLoader(); bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide(); loadHistory();}); } }
    function showPhotos() { const t=USER_TRIPS.find(x=>x.ID===CURRENT_TRIP_ID); if(t.AVIZ_1_POZA) window.open(t.AVIZ_1_POZA); else if(t.DELEGATIE_POZA) window.open(t.DELEGATIE_POZA); else alert("Fara poze"); }
    
    function setupAutocomplete(id, listId, data) { const inp=document.getElementById(id), list=document.getElementById(listId); inp.oninput=()=>{ const v=inp.value.toLowerCase(); list.innerHTML=''; if(!v){list.style.display='none';return;} const m=data.filter(x=>x&&x.toLowerCase().includes(v)); if(m.length){list.style.display='block'; m.forEach(x=>{const d=document.createElement('div');d.className='autocomplete-item';d.innerText=x;d.onclick=()=>{inp.value=x;list.style.display='none';};list.appendChild(d);});}else list.style.display='none'; }; document.onclick=e=>{if(e.target!==inp)list.style.display='none';}; }
    function toggleDiv(id,s) { const e=document.getElementById(id); if(s)e.classList.remove('hidden'); else e.classList.add('hidden'); }
    function showLoader(t) { document.getElementById('loaderText').innerText=t; document.getElementById('loader').style.display='flex'; }
    function hideLoader() { document.getElementById('loader').style.display='none'; }
    function triggerPhoto(id) { document.getElementById(id).click(); }
    function previewFile(inp) { const f=inp.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ FILE_CACHE[inp.id]=e.target.result.split(',')[1]; inp.parentElement.classList.add('has-file'); }; r.readAsDataURL(f); } }
  </script>
</body>
</html>
</body>
</html>
